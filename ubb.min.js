var UBB=function(){function p(a){this.setting=p.mix({defaultColor:"#000000",linkDefaultColor:"#006699",flashImage:"/skin/imgs/flash.png"},a),this.setting.tags=p.mix(g,this.setting.tags),this.setting.ubbTagsOrder={},this.setting.wrapUbbTags={};var b,c,d,e,f,h;a=this.setting;for(b in a.tags){c=a.tags[b];switch(c.canContains){case"*":a.ubbTagsOrder[b]=!0;break;case"":a.ubbTagsOrder[b]=!1;break;case undefined:a.ubbTagsOrder[b]=!1;break;default:f=c.canContains.split(","),h={};for(d=0,e=f.length;d<e;d++)h[f[d].toLowerCase()]=!0;a.ubbTagsOrder[b]=h}a.wrapUbbTags[b]=c.canWrap}}"use strict";var a={clone:function(b,c){c||(c=b,b=this);if(!b.isNode)return null;if(c){var d,e,f=b.clone();for(d=0,e=b.length;d<e;d++)b[d].isNode&&f.append(b[d].clone(!0));return f}return a.createNode(b.name,b.attr)},append:function(a,b){b||(b=a,a=this);if(!b)return a;if(b.parent)throw"Node "+b.name+" has a parent node!";return a.push(b),b.parent=a,a},getDeepestChild:function(a){var b;while(b=a[a.length-1])a=b;return a},createNode:function(b,c){var d=[];return d.isNode=!0,d.append=a.append,d.clone=a.clone,b&&(d.name=b),c&&(d.attr=c),d},createTextNode:function(b){var c=a.createNode("#text");return c.value=b,c}},b=/([A-Z])/g,c=/-([a-z])/g,d=/^-?\d/,e=/^-?\d+(?:px)?$/i,f=/\[(\/)?([a-zA-Z0-9]+)/,g={},h={block:1,table:1,"table-caption":1,"table-footer-group":1,"table-header-group":1,"table-row":1,"table-row-group":1,"list-item":1},i={img:1,object:1,button:1,textarea:1,input:1,select:1},j={pre:1,"pre-wrap":1,"pre-line":1},k={pre:1,"pre-wrap":1},l={isInlineBlock:function(a,b){var c=l.getComputedStyle(a,"display");return!!(c==="inline-block"||c==="inline"&&i[b])},hasBlockBox:function(a){return!!h[l.getComputedStyle(a,"display")]},isKeepNewLine:function(a,b){return b==="pre"||b==="textarea"?2:j[l.getComputedStyle(a,"white-space")]?1:0},isKeepWhiteSpace:function(a){return!!k[l.getComputedStyle(a,"white-space")]},ubbEscape:function(a){return a.replace(/(\[|\])/g,"\\$1")},changeState:function(a,b,c){var d=a.node,e=a.key,f,g={0:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0},1:{1:0,2:0,3:1,4:0,7:0,8:0},2:{1:1,2:1,3:1,4:0,7:1,8:1},3:{1:1,2:1,3:1,4:0,7:1,8:1}},h={1:1,2:2,3:3,5:2,6:1,7:2,8:2};f=g[e][b],f&&d&&(d.suffix=(d.suffix||"")+(f==1?"\n":"\n\n")),b in h&&(a.key=h[b]),a.node=c},parseNode:function(a,b,c,d,e,f){var g,h,i,j,k,m,n,o=f.boxStates,p=f.textStates,q=o[o.length-1],r=p[p.length-1];switch(c){case 8:return;case 3:i=a.nodeValue.replace(/\r\n/g,"\n"),j=r.keepNewLine,k=r.keepWhiteSpace,j||(i=i.replace(/^\n|\n$/g,"").replace(/\n/g," ")),k||(i=i.replace(/^[\u0020\u200B\u200A\u3000\u2000]*|[\u0020\u200B\u200A\u3000\u2000]*$/g,"").replace(/[\u0020\u200B\u200A\u3000\u2000]{2,}/g," ")),i=l.ubbEscape(i);if(i==="")return;m=j===2&&i.slice(0,1)==="\n"&&q.key===0,n=j&&i.length>1&&i.slice(-1)==="\n",k?i==="\n"?(e.text="",m?l.changeState(q,6,e):l.changeState(q,8,e)):m&&n?(e.text=i.slice(1,-1),l.changeState(q,5,e)):m?(e.text=i.slice(1),l.changeState(q,6,e)):n?(e.text=i.slice(0,-1),l.changeState(q,7,e)):(e.text=i,l.changeState(q,1,e)):(e.text=i,l.changeState(q,1,e));break;case 1:b==="br"?l.changeState(q,2,e):e.hasBlockBox?a.offsetHeight>0?l.changeState(q,3,e):l.changeState(q,2,e):l.changeState(q,l.isInlineBlock(a,b)?1:4,e);break;default:}for(g in d.tags)h=d.tags[g],h.parseHTML&&h.parseHTML(b,a,e,d);return e},treeToUbb:function(a){var b,c,d,e=[a.prefix||""];a.text&&e.push(a.text);for(b=0,c=a.length;b<c;b++)d=a[b],e.push(l.treeToUbb(d));return e.push(a.suffix||""),e.join("")},canContains:function(a,b,c){var d=c[a.name];return typeof d=="boolean"?d:d[b.name]},pushOpenUbbTag:function(b,c,d){var e;while(!b.isRoot&&!l.canContains(b,c,d))e?e=b.clone().append(e):e=b.clone(),b=b.parent;return b.append(c),e&&l.canContains(c,e,d)?(c.append(e),a.getDeepestChild(e)):c},pushCloseUbbTag:function(b,c){var d;while(!b.isRoot&&b.name!==c)d?d=b.clone().append(d):d=b.clone(),b=b.parent;return b.isRoot?b:(b=b.parent,b.append(d),d?a.getDeepestChild(d):b)},pushLineUbbTag:function(b,c){var d;while(!b.isRoot&&!c[b.name])d?d=b.clone().append(d):d=b.clone(),b=b.parent;return b.append(a.createTextNode("\n")),b.append(d),d?a.getDeepestChild(d):b},htmlEncode:function(a){return a&&(a=a.replace(/&/igm,"&amp;"),a=a.replace(/</igm,"&lt;"),a=a.replace(/>/igm,"&gt;"),a=a.replace(/\"/igm,"&quot;")),a},scanUbbText:function(b,c,d){d&&(b=l.htmlEncode(b)),b=b.replace(/\r\n/g,"\n");var e,g,h,i,j,k,m,n=c.ubbTagsOrder,o=c.wrapUbbTags,p=0,q=1,r=p,s=0,t=0,u=b.length,v="",w=a.createNode(),x=w;w.isRoot=!0;for(;t<u;t++){e=b.charAt(t);switch(e){case"\\":r=q;break;case"[":r===q?(v+="[",r=p):(v&&x.append(a.createTextNode(v)),v="[");break;case"]":r===q?(v+="]",r=p):(g=f.exec(v),g&&g[2]&&(h=g[2].toLowerCase())in n?(m=!!g[1],m||(k=v.slice(g[2].length+(g[1]?2:1)),i=a.createNode(h,k)),m?x=l.pushCloseUbbTag(x,h):x=l.pushOpenUbbTag(x,i,n)):x.append(a.createTextNode(v+"]")),v="");break;case"\n":r===q&&(r=p),v&&(x.append(a.createTextNode(v)),v=""),x=l.pushLineUbbTag(x,o);break;default:r===q&&(r=p),v+=e}}return v&&x.append(a.createTextNode(v)),w},parseUbbNode:function(a,b,c,d){var e=c.tags,f;if(a.name==="#text")return a.value==="\n"?d.nobr?(d.nobr=!1,""):"<br/>":(d.nobr=!1,a.value.replace(/\s/g,"&nbsp;"));if((f=e[a.name])&&f.parseUBB)return f.isBlock&&(d.nobr=!0),f.parseUBB(a,b,c)},fixUbbNode:function(a,b,c){return a.name==="#text"?l.ubbEscape(a.value):"["+a.name+(a.attr||"")+"]"+b+"[/"+a.name+"]"}},m=function(b,c,d,e){var f,g,h,i,j,k=a.createNode(),n=b.nodeType,o=b.nodeName.toLowerCase(),p=b.childNodes;d||(d={},d.boxStates=[],d.textStates=[]),n===1&&(l.hasBlockBox(b)&&(d.boxStates.push({key:0,node:null}),k.hasBlockBox=!0),d.textStates.push({keepNewLine:l.isKeepNewLine(b,o),keepWhiteSpace:l.isKeepNewLine(b)}));for(f=0,g=p.length;f<g;f++)j=m(p[f],c,d,!0),j&&k.append(j);return n===1&&d.textStates.pop(),k.hasBlockBox&&d.boxStates.pop(),e?l.parseNode(b,o,n,c,k,d):l.treeToUbb(k)},n=function(a,b,c){var d,e,f=[];c=c||{};if(a.isNode)for(d=0,e=a.length;d<e;d++)f.push(n(a[d],b,c));return a.isRoot?f.join(""):l.parseUbbNode(a,f.join(""),b,c)},o=function(a,b,c){var d,e,f=[];c=c||{};if(a.isNode)for(d=0,e=a.length;d<e;d++)f.push(o(a[d],b,c));return a.isRoot?f.join(""):l.fixUbbNode(a,f.join(""),b,c)};return document.defaultView&&document.defaultView.getComputedStyle?l.getComputedStyle=function(a,c){var d,e,f=a.ownerDocument.defaultView;if(!f)return;return c=c.replace(b,"-$1").toLowerCase(),d=f.getComputedStyle(a,null),d&&(e=d.getPropertyValue(c)),e}:l.getComputedStyle=function(a,b){b=b.replace(c,function(a){return a.charAt(1).toUpperCase()});var f,g,h=a.currentStyle&&a.currentStyle[b],i=a.style;return!e.test(h)&&d.test(h)&&(f=i.left,g=a.runtimeStyle.left,a.runtimeStyle.left=a.currentStyle.left,i.left=b==="fontSize"?"1em":h||0,h=i.pixelLeft+"px",i.left=f,a.runtimeStyle.left=g),h===""?"auto":h.toString()},p.extend=function(a,b){var c;for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},p.addTags=function(a){p.extend(g,a)},p.mix=function(a,b){var c,d={};return p.extend(d,a),p.extend(d,b),d},p.Util=l,p.prototype.HTMLtoUBB=function(a){return this.fixUBB(m(a,this.setting))},p.prototype.UBBtoHTML=function(a){return n(l.scanUbbText(a,this.setting,!0),this.setting)},p.prototype.fixUBB=function(a){return o(l.scanUbbText(a,this.setting),this.setting)},p}()
